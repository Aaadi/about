<html><head>
<link href="https://vjs.zencdn.net/6.2.7/video-js.css" rel="stylesheet">
<link href="player.css" rel="stylesheet">
<script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
<script src="https://vjs.zencdn.net/6.2.7/video.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/webtorrent/0.98.20/webtorrent.min.js"></script>
<script src="branding.js"></script>
<script src="persistvolume.js"></script>
<script src="resolutionswitcher.js"></script>
</head>
<body style='margin:0'>
<script>
  gateways = [
    "https://ipfs.io",
    "https://dtube1.gateway.ipfsstore.it:8443",
    "https://dtube2.gateway.ipfsstore.it:8443",
    "https://gateway.ipfs.io",
    "https://earth.i.ipfs.io",
    "https://gateway.ipfsstore.it:8443",
    "https://scrappy.i.ipfs.io",
    "https://chappy.i.ipfs.io"
  ]
  player = null
  itLoaded = false
  steem.api.setOptions({ url: 'https://api.steemit.com' });
  var path=window.location.href.split("#!/")[1];
  var autoplay = (path.split("/")[2] == 'true')
  var nobranding = (path.split("/")[3] == 'true')
  var videoGateway = path.split("/")[4]
  var snapGateway = path.split("/")[5]
  steem.api.getContent(path.split("/")[0], path.split("/")[1], function(d,b){
    var a=JSON.parse(b.json_metadata).video;
    if (!videoGateway) videoGateway = gatewayByHash(a.content.videohash)
    if (!snapGateway) snapGateway = gatewayByHash(a.info.snaphash)
    var qualities = []
    qualities.push({label: 'Source', type: 'video/mp4', src: linkByHash(a.content.videohash)})
    if (a.content.video480hash)
      qualities.push({label: '480p', type: 'video/mp4', src: linkByHash(a.content.video480hash)})
    createPlayer(linkByHash(a.content.videohash), linkByHash(a.info.snaphash), autoplay, nobranding, qualities)

    // if there's a magnet link, start torrent in background
    if (a.content.magnet) {
      var Torrent = new WebTorrent()
      Torrent.add(a.content.magnet, function (torrent) {
        // and switch when torrent is ready  and downloading at fair speed!
        torrent.on('download', function (bytes) {
          console.log('download speed: ' + torrent.downloadSpeed)
          console.log('progress: ' + torrent.progress)
          if (!itLoaded && torrent.downloadSpeed > a.info.filesize/a.info.duration) {
            itLoaded = true
            var file = torrent.files[0]
            var container = document.getElementsByTagName('video')[0]
            file.renderTo(container)
          }
        })
      })
    }
  });

  function createPlayer(videoUrl, posterUrl, autoplay, branding, qualities) {
    var c=document.createElement("video");
    c.src=videoUrl;
    c.poster=posterUrl;
    c.controls=true;
    c.autoplay=autoplay;
    c.id="player";
    c.className="video-js";
    c.style="width:100%;height:100%";
    c.addEventListener('loadeddata', function() {
      if(c.readyState >= 3) {
        itLoaded = true
      }
    });
    document.body.appendChild(c);
    player=videojs("player",{
      sourceOrder:true,
      sources:[
        {src:videoUrl,type:"video/mp4"}
      ],
      techOrder:["html5"],
      playbackRates:[0.25,0.5,0.75,1,1.25,1.5,2],
      controlBar:{
        currentTimeDisplay:true,
        timeDivider:true,
        durationDisplay:true
      },
      plugins: {
        persistvolume: {
          namespace: 'dtube'
        },
        videoJsResolutionSwitcher: {
          default: 'Source',
          dynamicLabel: true
        }
      }
    });
    player.brand({
      branding: !JSON.parse(nobranding),
      title:"Watch on DTube",
      destination:"http://d.tube/#!/v/"+path.split("/")[0]+'/'+path.split("/")[1],destinationTarget:"_blank",
      //qualities: qualities
    })
    player.updateSrc(qualities)
    player.on('resolutionchange', function(){
      console.info('Source changed to %s', player.src())
    })
  }

  function removePlayer() {
    var elem = document.getElementById('player');
    return elem.parentNode.removeChild(elem);
  }

  function gatewayByHash(ipfsHash) {
    var g = ipfsHash.charCodeAt(ipfsHash.length-1) % gateways.length
    return gateways[g].split('://')[1]
  }

  function linkByHash(ipfsHash) {
    return 'https://'+gatewayByHash(ipfsHash)+'/ipfs/'+ipfsHash
  }
</script>
</div>
</body>
</html>

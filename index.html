<html>

<head>
  <link href="https://vjs.zencdn.net/6.2.7/video-js.css" rel="stylesheet">
  <link href="player.css" rel="stylesheet">
  <script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
  <script src="https://vjs.zencdn.net/6.2.7/video.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/webtorrent/0.98.20/webtorrent.min.js"></script>
  <script src="branding.js"></script>
  <script src="persistvolume.js"></script>
  <script src="resolutionswitcher.js"></script>
  <script src="settingsmenubuttons.js"></script>
  <script src="settingsmenuitem.js"></script>
  <script src="hotkeys.js"></script>
</head>

<body style='margin:0'>
  <script>
    gateways = [
      "https://ipfs.io/ipfs/:hash",
      "https://gateway.ipfs.io/ipfs/:hash",
      "https://ipfs.infura.io/ipfs/:hash",
      "https://upload.global/ipfs/:hash",
      "https://siderus.io/ipfs/:hash",
      "https://www.eternum.io/ipfs/:hash",
      "https://hardbin.com/ipfs/:hash",
      "https://ipfs.macholibre.org/ipfs/:hash",
      "https://ipfs.works/ipfs/:hash",
      "https://ipfs.work/ipfs/:hash",
      "https://ipfs.wa.hle.rs/ipfs/:hash",
      "https://api.wisdom.sh/ipfs/:hash"
    ]

    player = null
    itLoaded = false
    steem.api.setOptions({
      url: 'https://api.steemit.com'
    });
    var path = window.location.href.split("#!/")[1];
    var autoplay = (path.split("/")[2] == 'true')
    var nobranding = (path.split("/")[3] == 'true')
    // var videoGateway = path.split("/")[4]
    // var snapGateway = path.split("/")[5]
    var hashToTest;
    steem.api.getContent(path.split("/")[0], path.split("/")[1], function (err, b) {
      if (err) {
        console.log(err)
        return
      }
      var a = JSON.parse(b.json_metadata).video;

      // if (!videoGateway) {
      //   videoGateway = checkHashAndGateways(a.content.videohash);
      // }
      // if (!snapGateway) snapGateway = checkHashAndGateways(a.info.snaphash)
      var qualities = []

      if (a.content.video480hash) {
        qualities.push({
          label: '480p',
          type: 'video/mp4',
          src: checkHashAndGateways(a.content.video480hash)
        })
        qualities.push({
          label: 'Source',
          type: 'video/mp4',
          src: checkHashAndGateways(a.content.videohash),
        })

        console.log(a.content.videohash)

        createPlayer(checkHashAndGateways(a.info.snaphash), autoplay, nobranding, qualities)
      } else {
        qualities.push({
          label: 'Source',
          type: 'video/mp4',
          src: linkByHash(a.content.videohash)
        })
        createPlayer(checkHashAndGateways(a.info.snaphash), autoplay, nobranding, qualities)
      }

      // if there's a magnet link, start torrent in background
      if (a.content.magnet) {
        var Torrent = new WebTorrent()
        Torrent.add(a.content.magnet, function (torrent) {
          // and switch when torrent is ready  and downloading at fair speed!
          torrent.on('download', function (bytes) {
            console.log('download speed: ' + torrent.downloadSpeed)
            console.log('progress: ' + torrent.progress)
            if (!itLoaded && torrent.downloadSpeed > a.info.filesize / a.info.duration) {
              itLoaded = true
              var file = torrent.files[0]
              var container = document.getElementsByTagName('video')[0]
              file.renderTo(container)
            }
          })
        })
      }
    });

    function createPlayer(posterUrl, autoplay, branding, qualities) {
      var c = document.createElement("video");
      //c.src=videoUrl;
      c.poster = posterUrl;
      c.controls = true;
      c.autoplay = autoplay;
      c.id = "player";
      c.className = "video-js";
      c.style = "width:100%;height:100%";
      c.addEventListener('loadeddata', function () {
        if (c.readyState >= 3) {
          itLoaded = true
        }
      });
      document.body.appendChild(c);
      player = videojs("player", {
        inactivityTimeout: 1000,
        sourceOrder: true,
        sources: qualities,
        techOrder: ["html5"],
        'playbackRates': [0.25, 0.5, 0.75, 1, 1.25, 1.5, 2],
        controlBar: {
          children: {
            'playToggle': {},
            'muteToggle': {},
            'volumeControl': {},
            'currentTimeDisplay': {},
            'timeDivider': {},
            'durationDisplay': {},
            'liveDisplay': {},
            'flexibleWidthSpacer': {},
            'progressControl': {},
            'settingsMenuButton': {
              entries: [
                //  'subtitlesButton',
                //  'captionsButton',
                'playbackRateMenuButton'
              ]
            },
            'fullscreenToggle': {}
          }
        },
        plugins: {
          persistvolume: {
            namespace: 'dtube'
          },
          videoJsResolutionSwitcher: {
            default: qualities[0].label
          }
        }
      });
      videojs('player').ready(function () {
        this.hotkeys({
          volumeStep: 0.05,
          seekStep: 5,
          enableModifiersForNumbers: false
        });
      });
      player.brand({
        branding: !JSON.parse(nobranding),
        title: "Watch on DTube",
        destination: "http://d.tube/#!/v/" + path.split("/")[0] + '/' + path.split("/")[1],
        destinationTarget: "_blank"
      })
      //player.updateSrc(qualities)
      player.on('resolutionchange', function () {
        console.info('Source changed to %s', player.src())
      })
    }

    function removePlayer() {
      var elem = document.getElementById('player');
      return elem.parentNode.removeChild(elem);
    }

    function gatewayByHash(ipfsHash) {
      var g = ipfsHash.charCodeAt(ipfsHash.length - 1) % gateways.length
      return gateways[g].split('://')[1]
    }

    function linkByHash(ipfsHash) {
      return 'https://' + gatewayByHash(ipfsHash) + '/ipfs/' + ipfsHash
    }


    function checkHashAndGateways(hashToTest) {
      const total = gateways.length
      let checked = 0
      gateways.forEach((gateway) => {
        const gatewayAndHash = gateway.replace(':hash', hashToTest)
        fetch(gatewayAndHash)
          .then(res => res)
          .then((res) => {
          checked++
          updateStats(total, checked)
            switch(res.status) {
              case 200:
                  console.log('Server Status ' + res.status)
                  console.log(gatewayAndHash + ' Node Online')
                  return gatewayAndHash
                  break;
              default:
              console.log('strange')
              break;
          }
          }).catch((err) => {
            window.err = err
            console.log(gatewayAndHash, false, err)
            // selectNode(gatewayAndHash, false, err)
            checked++
            updateStats(total, checked)
          })
      })
    }

    function updateStats(total, checked) {
      console.log(checked + '/' + total + ' gateways checked')
    }

  </script>
</body>

</html>